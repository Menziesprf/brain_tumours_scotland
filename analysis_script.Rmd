---
title: "Analysis_script"
author: "Peter Menzies"
date: "25/01/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, warning=F, message=F}
source("cleaning_exploration_script.R")
```

### Incidence

```{r}
incidence_all_ages %>%
  drop_na() %>% 
  filter(sex == "all",
         cancer_type == "mal_brain",
         age == "all",
         hb != "scotland") %>% 
  ggplot() +
  aes(x = year, y = incidence) +
  geom_line() +
  facet_wrap(~ hb) +
  labs(title = "Malignant tumours")

incidence_all_ages %>%
  drop_na() %>% 
  filter(sex == "all",
         cancer_type == "mal_brain",
         age == "all",
         hb != "scotland") %>% 
  ggplot() +
  aes(x = year, y = num_cases) +
  geom_line() +
  facet_wrap(~ hb) +
  labs(title = "Malignant tumours")
```

* Big fluctuations in Incidence in Orkney, shetland, western isles and borders due to small population

* Largest number of cases in SE, West and North of Scotland and greater glasgow, but a similar incidence compared to other hb areas/across scotland as a whole 

```{r}
incidence_all_ages %>%
  drop_na() %>% 
  filter(sex == "all",
         cancer_type == "all",
         age == "all",
         hb != "scotland") %>% 
  ggplot() +
  aes(x = year, y = incidence) +
  geom_line() +
  facet_wrap(~ hb) +
  labs(title = "All tumours")

incidence_all_ages %>% 
  drop_na() %>% 
  filter(sex == "all",
         cancer_type == "all",
         age == "all",
         hb != "scotland") %>% 
  ggplot() +
  aes(x = year, y = num_cases) +
  geom_line() +
  facet_wrap(~ hb)+
  labs(title = "All tumours")
```

* Same take aways as above


```{r}
incidence_all_ages %>% 
  filter(hb == "scotland",
         sex == "all",
         age == "all",
         cancer_type == "mal_brain")
```

* 357 Malignant brain tumours in 1994, 17 pituitary gland, craniopharyngeal duct and pineal gland tumours. Incidence 7 per 100k 

* 451 Malignant brain tumours in 2018, 19 pituitary gland, craniopharyngeal duct and pineal gland tumours, 496 non-malignant brain tumours. 8.3 per 100k 

* In 2018 1.2 people were diagnosed per day with a malignant brain tumour



```{r}
incidence_all_ages %>%
  drop_na() %>% 
  filter(sex == "all",
         age == "all",
         hb == "scotland") %>% 
  ggplot() +
  aes(x = year, y = incidence) +
  geom_line() +
  facet_wrap(~ cancer_type)+
  labs(title = "Scotland")

incidence_all_ages %>% 
  drop_na() %>% 
  filter(sex == "all",
         age == "all",
         hb == "scotland") %>% 
  ggplot() +
  aes(x = year, y = num_cases) +
  geom_line() +
  facet_wrap(~ cancer_type)+
  labs(title = "Scotland")
```

* Increase in cases and incidence across Scotland between 1994 and 2018. Peaked at 2013.

* The biggest change seems to be in non-malignant tumours

* Not a massive change in incidence in malignant tumours 



```{r}
incidence_all_stats %>%  
  drop_na() %>% 
  filter(value_type %in% c("crude_rate", "easr", "wasr"),
         hb != "scotland",
         sex == "all",
         cancer_type == "mal_brain") %>% 
  ggplot() +
  aes(x = year, y = value, colour = value_type) +
  geom_line() +
  facet_wrap(~ hb)
```

* Again lots of fluctuation due to small populations in health boards
* WASR consistently lower
* EASR and crude rate seem pretty similar, EASR a touch higher than crude_rate, suggesting scotland has lower incidence than they should compared to europe?

```{r}
incidence_all_stats %>%
  drop_na() %>% 
  filter(value_type %in% c("crude_rate", "easr", "wasr"),
         hb == "scotland",
         cancer_type == "mal_brain") %>% 
  ggplot() +
  aes(x = year, y = value, colour = value_type) +
  geom_line() +
  facet_wrap(~ sex)
```

* As above regarding rates

* Male rate is significantly higher than female rate.


* Is this the same across age groups 

```{r}
incidence_all_ages %>%
  drop_na() %>% 
  filter(age != "all",
         hb == "scotland",
         cancer_type == "mal_brain") %>% 
  ggplot() +
  aes(x = year, y = incidence, colour = sex) +
  geom_line() +
  facet_wrap(~ age)+
  labs(title = "Scotland, malignant")

incidence_all_ages %>%
  drop_na() %>% 
  filter(age != "all",
         hb == "scotland",
         cancer_type == "mal_brain") %>% 
  ggplot() +
  aes(x = year, y = num_cases, colour = sex) +
  geom_line() +
  facet_wrap(~ age)+
  labs(title = "Scotland, malignant")

incidence_all_ages %>%
  drop_na() %>% 
  filter(age != "all",
         hb == "scotland",
         cancer_type == "non_mal_plus_glands") %>% 
  ggplot() +
  aes(x = year, y = incidence, colour = sex) +
  geom_line() +
  facet_wrap(~ age)+
  labs(title = "Scotland, non_mal")

incidence_all_ages %>%
  drop_na() %>% 
  filter(age != "all",
         hb == "scotland",
         cancer_type == "non_mal_plus_glands") %>% 
  ggplot() +
  aes(x = year, y = num_cases, colour = sex) +
  geom_line() +
  facet_wrap(~ age)+
  labs(title = "Scotland, non_mal")

incidence_all_ages %>%
  drop_na() %>% 
  filter(age != "all",
         hb == "scotland",
         cancer_type == "all") %>% 
  ggplot() +
  aes(x = year, y = incidence, colour = sex) +
  geom_line() +
  facet_wrap(~ age)+
  labs(title = "Scotland, all")

incidence_all_ages %>%
  drop_na() %>% 
  filter(age != "all",
         hb == "scotland",
         cancer_type == "all") %>% 
  ggplot() +
  aes(x = year, y = num_cases, colour = sex) +
  geom_line() +
  facet_wrap(~ age)+
  labs(title = "Scotland, all")


```

* Malignant tumours:
* Incidence is highest in Males in all age groups
* Incidence is highest in 50 +, and increase in each age group from 50 onwards with a certain amount of annual fluctation

* Non-malignant:
* Incidence is higher in Females
* Starts to rise 45 ish... and from 70 onwards.
* Big increase from 2008ish? in elderly population


```{r}
incidence_all_ages %>% 
  filter(year == 1994,
         sex != "all",
         hb == "scotland",
         cancer_type %in% c("mal_brain", "non_mal_plus_glands"))
```

```{r}
incidence_all_ages %>%
  drop_na() %>% 
  filter(age == "all",
         hb == "scotland",
         cancer_type == "mal_brain") %>% 
  ggplot() +
  aes(x = year, y = incidence, colour = sex) +
  geom_line() +
  labs(title = "Scotland, malignant")

incidence_all_ages %>%
  drop_na() %>% 
  filter(age == "all",
         hb == "scotland",
         cancer_type == "mal_brain") %>% 
  ggplot() +
  aes(x = year, y = num_cases, colour = sex) +
  geom_line() +
  labs(title = "Scotland, malignant")
```

* Increasing incidence associated with increasing population?

# Mortality

```{r}
mort_ages %>% 
  filter(hb == "scotland",
         age == "all") %>% 
  ggplot() +
  aes(x = year, y = mortality_rate, colour = sex) +
  geom_line() +
  facet_wrap(~ cancer_type) +
  labs(title = "Scotland, all ages")

mort_ages %>% 
  filter(hb == "scotland",
         age == "all") %>% 
  ggplot() +
  aes(x = year, y = num_deaths, colour = sex) +
  geom_line() +
  facet_wrap(~ cancer_type) +
  labs(title = "Scotland, all ages")
```

* Mortality rate is higher in males and increases from 1994 to 2018...is this just because incidence is higher or are people dying at higher rate once diagnosed?...need to review mortality rate definition



# Survival rate

```{r}
survival_clean %>% 
  filter(age_group == "15-99") %>% 
  ggplot() +
  aes(x = calendar_period_of_diagnosis, y = observed_survival_percent, fill = sex) +
  geom_col() +
  facet_wrap(~ years_since_diagnosis) +
  labs(title = "age 15-99")

survival_clean %>% 
  filter(age_group == "15-99") %>% 
  ggplot() +
  aes(x = calendar_period_of_diagnosis, y = net_survival_percent, fill = sex) +
  geom_col() +
  facet_wrap(~ years_since_diagnosis) +
  labs(title = "age 15-99")
```

* Increase in 1 year survival but no change in 5 year survival

```{r}
survival_clean %>% 
  filter(age_group == "15-74",
         years_since_diagnosis == "10") %>% 
  ggplot() +
  aes(x = calendar_period_of_diagnosis, y = observed_survival_percent, fill = sex) +
  geom_col() +
  labs(title = "age 15-74")

survival_clean %>% 
  filter(age_group == "15-74",
         years_since_diagnosis == "10") %>% 
  ggplot() +
  aes(x = calendar_period_of_diagnosis, y = net_survival_percent, fill = sex) +
  geom_col() +
  labs(title = "age 15-74")
```

* 10 year survival for ages 15 - 74 has not changed much 


```{r}
survival_clean %>% 
  filter(years_since_diagnosis == 10,
         age_group == "15-74")
```

# Age

```{r}
pop_clean_94 <- pop_clean %>% 
  filter(year == 1994) 

pop_clean_04 <- pop_clean %>% 
  filter(year == 2004)

pop_clean_14 <- pop_clean %>% 
  filter(year == 2014)

pop_clean_19 <- pop_clean %>% 
  filter(year == 2019)

```


* Aging population, so we can expect an increase in brain cancer incidence


```{r}
pop_clean_94 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -count_group, count_group), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "1994") +
  scale_x_continuous(n.breaks =  10)

pop_clean_04 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -count_group, count_group), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "2004") +
  scale_x_continuous(n.breaks =  10)

pop_clean_14 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -count_group, count_group), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "2014") +
  scale_x_continuous(n.breaks =  10)

pop_clean_19 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -count_group, count_group), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "2019") +
  scale_x_continuous(n.breaks =  10) 

pop_clean_94 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -percentage_pop, percentage_pop), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "1994") +
  scale_x_continuous(n.breaks =  10)

pop_clean_04 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -percentage_pop, percentage_pop), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "2004") +
  scale_x_continuous(n.breaks =  10)

pop_clean_14 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -percentage_pop, percentage_pop), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "2014") +
  scale_x_continuous(n.breaks =  10)

pop_clean_19 %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -percentage_pop, percentage_pop), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population",
       title = "2019") +
  scale_x_continuous(n.breaks =  10)


```



```{r}
pop_2019_hb_clean %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -percentage_pop, percentage_pop), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population") +
  facet_wrap(~ hb)

pop_2019_hb_clean %>% 
  ggplot() +
  aes(x = ifelse(sex == "male", -count_group, count_group), 
      y = age_group, 
      fill = sex) +
  geom_col() +
  labs(x = "Population") +
  facet_wrap(~ hb)
```

* 

```{r}
over <- c("65-69", "70-74", "75-79", "80-84", "85-89", "90+")

pop_hb_2019_grouped <- pop_2019_hb_clean %>% 
  mutate(over_65 = case_when(age_group %in% over ~ "over_65",
                             T ~ "under_65")) %>% 
  group_by(sex, hb, over_65) %>% 
  mutate(percent_over_65 = sum(percentage_pop)) %>% 
  select(-age_group, -total_pop, -count_group, -percentage_pop) %>% 
  distinct()

pop_hb_2019_grouped %>% 
  filter(sex == "male") %>% 
  ggplot() + 
  aes(x = over_65, y = percent_over_65) +
  geom_col() +
  facet_wrap(~ hb)
```

* using both male and female ->

```{r}
pop_2019_all_clean %>% 
  ggplot() +
  aes(x = over_65, y = percentage_pop) +
  geom_col() +
  facet_wrap(~ hb)
```




